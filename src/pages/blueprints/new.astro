---
import Editor from "@components/Editor";
import Base from "@layouts/Base.astro";

const initText = `{
    "name": "",
    "templates": []
}`;
---

<Base title="New Blueprint">
    <h1 class="text-3xl mb-2 font-bold">Create a New Blueprint</h1>
    <div class="mb-4">
        <p>
            Currently new blueprint definitions are code-only. A graphical
            editor for composing blueprints is coming later.
        </p>
    </div>
    <div id="values" data-init-text={initText}></div>
    <div class="flex min-h-[500px] mb-4">
        <Editor client:only="preact" initValue={initText} />
    </div>
    <div class="mt-3">
        <button
            id="run"
            class="inline-flex items-center text-white bg-blue-700 hover:bg-blue-800 focus:outline-none focus:ring-4 focus:ring-blue-300 font-medium rounded-full text-sm px-5 py-2.5 text-center mr-2 mb-2 dark:bg-blue-600 dark:hover:bg-blue-700 dark:focus:ring-blue-800"
        >
            Create
        </button>
    </div>
</Base>

<script>
    import { code } from "src/stores/codeStore";

    const values = document.getElementById("values");
    code.set(values?.dataset.initText || "");

    const runButton = document.getElementById("run");
    runButton?.addEventListener("click", async () => {
        const blueprint = JSON.parse(code.get());
        blueprint.templates = JSON.stringify(blueprint.templates, null, 4);
        const response = await fetch("http://localhost:8080/v1/blueprints", {
            method: "post",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify(blueprint),
            mode: "cors",
            credentials: "include",
        });
        const body = await response.json();
        console.log(body);
        if (response.ok) {
            window.location.assign(`/blueprints/${body.id}`);
        }
    });
</script>
