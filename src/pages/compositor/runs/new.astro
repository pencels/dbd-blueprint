---
import Editor from "@components/Editor";
import Base from "@layouts/Base.astro";

const initText = `[
    {
        "canvas_size": [256, 256],
        "aliases": {
            "$fg": ["default-icons:Perks/**"]
        },
        "layers": [
            {
                "use": "black-backgrounds:perk_template.png"
            },
            {
                "use": "$fg"
            }
        ]
    }
]`;
---

<Base title="New Run">
    <h1 class="text-3xl mb-2 font-bold">Edit a New Run</h1>
    <div class="mb-4">
        <p>
            Currently new blueprint runs are code-only. A graphical editor for
            composing blueprints is coming later.
        </p>
    </div>
    <div id="values" data-init-text={initText}></div>
    <div class="flex min-h-[600px] mb-4">
        <Editor client:only="preact" initValue={initText} />
    </div>
    <div class="mt-3">
        <button
            id="run"
            class="inline-flex items-center text-white bg-blue-700 hover:bg-blue-800 focus:outline-none focus:ring-4 focus:ring-blue-300 font-medium rounded-full text-sm px-5 py-2.5 text-center mr-2 mb-2 dark:bg-blue-600 dark:hover:bg-blue-700 dark:focus:ring-blue-800"
        >
            <svg
                class="w-3.5 h-3.5 mr-2"
                aria-hidden="true"
                xmlns="http://www.w3.org/2000/svg"
                fill="currentColor"
                viewBox="0 0 14 16"
            >
                <path
                    d="M0 .984v14.032a1 1 0 0 0 1.506.845l12.006-7.016a.974.974 0 0 0 0-1.69L1.506.139A1 1 0 0 0 0 .984Z"
                ></path>
            </svg>
             Run
        </button>
    </div>
</Base>

<script>
    import { code } from "src/stores/codeStore";

    const values = document.getElementById("values");
    code.set(values?.dataset.initText || "");

    const blueprintRequest = {
        templates: code.get(),
    };

    const runButton = document.getElementById("run");
    runButton?.addEventListener("click", async () => {
        const response = await fetch("http://localhost:8080/v1/compositor", {
            method: "post",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify(blueprintRequest),
            mode: "cors",
            credentials: "include",
        });
        const body = await response.json();
        if (response.ok) {
            window.location.assign(`/compositor/runs/${body.run_id}`);
        }
    });
</script>
